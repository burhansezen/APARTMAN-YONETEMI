<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apartman Borç Durumu</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #f1f5f9; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8 text-center">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Apartman Güncel Borç Durumu</h1>
        <p class="text-sm text-gray-500">
            Bu sayfa sadece bilgilendirme amaçlıdır. Ödemeler ve detaylar için yönetici ile iletişime geçiniz.
        </p>
    </header>

    <main>
        <div class="card bg-white p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Daire Bakiyeleri (Borç/Alacak)</h2>
            <div id="apartment-list-container" class="custom-scroll max-h-[80vh] overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Daire No / Sakin</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Bakiye (₺)</th>
                        </tr>
                    </thead>
                    <tbody id="apartment-list" class="bg-white divide-y divide-gray-200">
                        <!-- Daireler buraya yüklenecek -->
                    </tbody>
                </table>
                <p id="no-apartments" class="text-center text-gray-500 p-8 hidden">Henüz kayıtlı daire yok.</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth;
        let userId = 'default-user';
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let apartments = [];
        let transactions = [];

        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    startDataListeners();
                } else {
                    signInAnonymously(auth);
                }
            });
        } catch (error) {
            console.error("Firebase başlatılırken bir hata oluştu:", error);
        }

        const getApartmentCollectionRef = () => collection(db, `artifacts/${APP_ID}/users/${userId}/apartments`);
        const getTransactionCollectionRef = () => collection(db, `artifacts/${APP_ID}/users/${userId}/transactions`);

        function startDataListeners() {
            onSnapshot(query(getApartmentCollectionRef()), snapshot => {
                apartments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateBalancesAndRender();
            });

            onSnapshot(getTransactionCollectionRef(), snapshot => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateBalancesAndRender();
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(amount);
        }

        function updateBalancesAndRender() {
            if (apartments.length === 0 || transactions.length === 0) {
                 // Her iki veri seti de gelmeden işlem yapma
                if(apartments.length > 0) renderApartments(); // Eğer hiç transaction yoksa bile daireleri göster
            }

            apartments.forEach(ap => {
                const initial = parseFloat(ap.initial_balance || 0);
                let apartmentBalance = initial;
                transactions.filter(t => t.apartment_id === ap.id).forEach(t => {
                    const amount = parseFloat(t.amount);
                    if (t.type === 'Gelir') apartmentBalance += amount;
                    else if (t.type === 'Gider') apartmentBalance -= amount;
                });
                ap.balance = apartmentBalance;
            });

            renderApartments();
        }

        function renderApartments() {
            const list = document.getElementById('apartment-list');
            list.innerHTML = '';

            if (apartments.length === 0) {
                document.getElementById('no-apartments').classList.remove('hidden');
                return;
            }
            document.getElementById('no-apartments').classList.add('hidden');

            const sortedApartments = [...apartments].sort((a, b) => a.balance - b.balance);

            sortedApartments.forEach(ap => {
                const balance = parseFloat(ap.balance || 0);
                let balanceClass = 'text-gray-700';
                let balanceText = formatCurrency(Math.abs(balance));
                let rowClass = '';

                if (balance < 0) {
                    balanceClass = 'text-red-600 font-bold';
                    balanceText = formatCurrency(Math.abs(balance)) + ' (Borç)';
                    rowClass = 'bg-red-50';
                } else if (balance > 0) {
                    balanceClass = 'text-green-600 font-bold';
                    balanceText = formatCurrency(balance) + ' (Alacak)';
                     rowClass = 'bg-green-50';
                }

                const row = `
                    <tr class="${rowClass}">
                        <td class="px-3 py-3 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">${ap.apartment_number}</div>
                            <div class="text-xs text-gray-500">${ap.resident_name}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-right text-sm ${balanceClass}">
                            ${balanceText}
                        </td>
                    </tr>
                `;
                list.insertAdjacentHTML('beforeend', row);
            });
        }
    </script>
</body>
</html>
